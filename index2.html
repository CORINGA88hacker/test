<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LelebMangas</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- SortableJS para drag & drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    .fade-in {
      animation: fadeIn 0.4s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.96); }
      to { opacity: 1; transform: scale(1); }
    }
    .loader {
      border: 4px solid #e5e7eb;
      border-top: 4px solid #10b981;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans flex flex-col min-h-screen">

  <header class="fixed top-0 left-0 w-full bg-gray-900 border-b border-gray-700 shadow-md z-50">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-3xl font-extrabold text-emerald-400 select-none tracking-wide"> </h1>
    </div>
  </header>

  <main x-data="mangaApp()" class="flex-grow container mx-auto px-6 py-32 sm:py-20 max-w-5xl">

    <section class="bg-gray-800 rounded-2xl p-8 shadow-xl border border-gray-700">
      <h2 class="text-4xl font-extrabold text-emerald-400 mb-3 select-none">üñºÔ∏è Juntar Mang√° com Marca d‚Äô√Ågua</h2>
      <p class="text-gray-400 mb-8 leading-relaxed max-w-3xl">
        Fa√ßa upload das p√°ginas do seu mang√°, organize a ordem facilmente e gere uma imagem √∫nica com a marca d‚Äô√°gua personalizada sobre a √∫ltima p√°gina.
      </p>

      <div class="space-y-6">

        <div>
          <label for="inputImagens" class="block mb-2 font-semibold text-gray-300 cursor-pointer hover:text-emerald-400 transition">
            üìÇ Selecione as p√°ginas do mang√°:
          </label>
          <input type="file" id="inputImagens" multiple accept="image/*"
            @change="carregarImagens($event)"
            class="file:bg-emerald-500 file:text-white file:px-5 file:py-3 file:rounded-lg file:hover:bg-emerald-600 w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-400"
          />
        </div>

        <div>
          <label for="inputMarca" class="block mb-2 font-semibold text-gray-300 cursor-pointer hover:text-emerald-400 transition">
            üñºÔ∏è Selecione a marca d‚Äô√°gua (PNG/JPG, opcional):
          </label>
          <input type="file" id="inputMarca" accept="image/*"
            @change="carregarMarca($event)"
            class="file:bg-yellow-500 file:text-black file:px-5 file:py-3 file:rounded-lg file:hover:bg-yellow-600 w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-gray-200 focus:outline-none focus:ring-2 focus:ring-yellow-400"
          />
        </div>

        <div class="flex flex-wrap gap-4 justify-center">
          <button
            @click="ordenarAutomaticamente()"
            class="bg-sky-600 hover:bg-sky-700 text-white px-8 py-3 rounded-lg font-semibold shadow-lg transition flex items-center gap-2"
            aria-label="Ordenar imagens automaticamente"
          >
            üî¢ Ordenar Automaticamente
          </button>

          <button
            @click="juntarImagens()"
            class="bg-emerald-600 hover:bg-emerald-700 text-white px-10 py-3 rounded-lg font-extrabold shadow-lg transition flex items-center gap-2"
            aria-label="Juntar e baixar a imagem"
          >
            üì• Juntar e Baixar
          </button>
        </div>

        <p class="text-gray-400 text-center" x-text="statusMsg" role="alert" aria-live="polite"></p>

        <section id="previewContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-8 mt-10"
                 x-show="imagens.length > 0" x-transition>
          <template x-for="(imagem, idx) in imagens" :key="imagem.name">
            <div class="bg-gray-700 rounded-xl p-4 shadow-2xl flex flex-col items-center cursor-move hover:scale-105 hover:bg-gray-600 transition transform select-none"
                 :data-index="idx" aria-grabbed="false" tabindex="0">
              <img :src="imagem.url" alt="imagem do mang√°" class="h-48 object-contain mb-3 rounded-lg border border-gray-600" />
              <input type="number" min="1" class="w-20 text-center p-2 rounded-lg bg-gray-800 text-white border border-gray-600 text-lg font-bold"
                x-model.number="imagem.ordem"
                aria-label="Ordem da imagem"
                @input="ordenarPorInput(idx)"
              />
              <p class="mt-2 text-sm text-gray-300 text-center break-words select-text" x-text="imagem.name"></p>
            </div>
          </template>
        </section>

      </div>
    </section>

    <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" aria-live="assertive" aria-label="Carregando">
      <div class="loader" role="status" aria-hidden="true"></div>
    </div>

  </main>

  <footer class="bg-gray-800 border-t border-gray-700 py-6 text-center text-gray-500 select-none">
    ¬© 2025 LelebMangas
  </footer>

  <canvas id="canvasFinal" style="display:none;"></canvas>

  <script>
    function mangaApp() {
      return {
        imagens: [],
        marcaDataURL: null,
        statusMsg: '',
        loading: false,
        sortable: null,

        carregarImagens(event) {
          this.imagens = [];
          const files = Array.from(event.target.files);
          files.forEach((file, i) => {
            const url = URL.createObjectURL(file);
            this.imagens.push({ file, url, name: file.name, ordem: i + 1 });
          });
          this.statusMsg = `${this.imagens.length} imagem(ns) carregada(s).`;
          this.$nextTick(() => {
            this.iniciarSortable();
          });
        },

        carregarMarca(event) {
          const file = event.target.files[0];
          if (!file) {
            this.marcaDataURL = null;
            this.statusMsg = "Marca d‚Äô√°gua padr√£o ser√° usada.";
            return;
          }
          const reader = new FileReader();
          reader.onload = e => {
            this.marcaDataURL = e.target.result;
            this.statusMsg = "Marca d‚Äô√°gua carregada!";
          };
          reader.readAsDataURL(file);
        },

        ordenarAutomaticamente() {
          if (this.imagens.length === 0) {
            Swal.fire('Aten√ß√£o', 'Nenhuma imagem carregada.', 'warning');
            return;
          }
          this.imagens.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
          this.imagens.forEach((img, i) => img.ordem = i + 1);
          this.statusMsg = "Imagens ordenadas automaticamente!";
          Swal.fire('Sucesso', 'Imagens ordenadas automaticamente!', 'success');
          this.$nextTick(() => {
            this.iniciarSortable();
          });
        },

        iniciarSortable() {
          if(this.sortable) {
            this.sortable.destroy();
          }
          const container = document.getElementById('previewContainer');
          this.sortable = Sortable.create(container, {
            animation: 150,
            ghostClass: 'bg-emerald-700',
            onEnd: evt => {
              // Atualiza a ordem no array e input number baseado na nova posi√ß√£o visual
              const nodes = Array.from(container.children);
              nodes.forEach((node, idx) => {
                const index = parseInt(node.getAttribute('data-index'));
                this.imagens[index].ordem = idx + 1;
              });
              // Reorganiza o array para manter o estado consistente
              this.imagens.sort((a, b) => a.ordem - b.ordem);
              this.statusMsg = "Ordem atualizada via arrastar e soltar.";
            }
          });
        },

        ordenarPorInput(idx) {
          const img = this.imagens[idx];
          let val = img.ordem;

          if (val < 1 || !Number.isInteger(val)) {
            img.ordem = 1;
            val = 1;
          }

          let ordensUsadas = this.imagens.filter((_, i) => i !== idx).map(i => i.ordem);
          while (ordensUsadas.includes(val)) {
            val++;
          }
          img.ordem = val;

          this.imagens.sort((a,b) => a.ordem - b.ordem);
          this.statusMsg = "Ordem atualizada via input.";
        },

        async juntarImagens() {
          if (this.imagens.length === 0) {
            Swal.fire('Aten√ß√£o', 'Nenhuma imagem carregada.', 'warning');
            return;
          }

          const ordens = this.imagens.map(img => img.ordem);
          const setOrdens = new Set(ordens);
          if (ordens.some(o => !Number.isInteger(o) || o < 1) || setOrdens.size !== ordens.length) {
            Swal.fire('Erro', 'Verifique se todos os n√∫meros de ordem est√£o preenchidos, s√£o inteiros positivos e √∫nicos.', 'error');
            return;
          }

          this.loading = true;
          this.statusMsg = "Processando imagens...";

          try {
            const ordenado = [...this.imagens].sort((a, b) => a.ordem - b.ordem);

            const imgsCarregadas = await Promise.all(ordenado.map(item => new Promise(resolve => {
              const img = new Image();
              img.onload = () => resolve(img);
              img.onerror = () => resolve(null);
              img.src = item.url;
            })));

            const imgsValidas = imgsCarregadas.filter(Boolean);

            if(imgsValidas.length === 0){
              throw new Error("Nenhuma imagem v√°lida para juntar.");
            }

            const marcaBase64Padrao = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAABnRSTlMA/wD/AP83WBt9AAAClElEQVR4Ae2YTYxjQRSHv7kQVyAdC3AEZEnIA0RGDFDkx0FxOsKooHgpXGB+4Yb6MSZjLXGSeIIJhcTTZ4wp2Xqz4xW7OV0sLaOl12a/9vNcsm4CTD2W7T9/8sxQ7Mw6LqZ3XvvQGgGPqAdR91Eg6jl57A7jgEx0h7PhXj42/0RsAyP8Yh+f6x+wFEE9Q0Ng4Vf8A7pxHsmEdYObXgu0DDaBL+jkiZj86hAnYwRgGgDxAnCdGcZdhCN4IHhx91gm52ny0FFosNKj4P5z6eNPPyVAcBJpNqS7QJ8mXsQ6EfsbEcAfZhr0dgd+Zy87Gv8Yt2CnkXhgDxrfWQa0v1XPwuAAVxhyqf+mLn5lPAOgAmAdALH4gBIY4HgS/8OJeAWEzFwJrF0jpBJ2dRWLPq8+Z3VoKZFiXOSDwKdAcU7cNxt7qfNzXCs1wD4HaEQ68AUHWCNecghlsB1xWwwRmA6TpEMZj1kOfgs6QJnIeAi72JDZPeclFQiIjw6CCkRnwDoFAvIBr68BQJzXCrj5a+04+7mj6iBAeERQysBz39ZfM/H5IBiZjC1QoQA+h+SjKyi/7fMwVCAJ+HavB7wHWxCr4EKlEpQxxgR9RGPYl2mEWm7qEPQAAAb5rTfYCE1QAAAABJRU5ErkJggg==";

            const marcaAgua = await new Promise((resolve, reject) => {
              const img = new Image();
              img.onload = () => resolve(img);
              img.onerror = () => reject("Erro ao carregar a marca d'√°gua.");
              img.src = this.marcaDataURL || marcaBase64Padrao;
            });

            // Aqui a grande mudan√ßa: define largura do canvas como a MENOR largura das imagens para n√£o ampliar
            const larguraCanvas = Math.min(...imgsValidas.map(img => img.width));
            const alturaTotal = imgsValidas.reduce((soma, img) => soma + img.height, 0);

            const canvas = document.getElementById('canvasFinal');
            canvas.width = larguraCanvas;
            canvas.height = alturaTotal;
            const ctx = canvas.getContext('2d');

            let y = 0;
            for (let i = 0; i < imgsValidas.length; i++) {
              const img = imgsValidas[i];
              const larguraDesenho = Math.min(img.width, larguraCanvas);

              // Desenha a imagem na largura original ou limitada (corta se maior que canvas)
              ctx.drawImage(img, 0, y, larguraDesenho, img.height);

              if (i === imgsValidas.length -1) {
                // Marca d'√°gua sobre a √∫ltima imagem
                const larguraMarca = Math.min(larguraDesenho * 0.6, marcaAgua.width);
                const escala = larguraMarca / marcaAgua.width;
                const alturaMarca = marcaAgua.height * escala;

                const posX = (larguraDesenho - larguraMarca) / 2;
                const posY = y + img.height - alturaMarca - 15;

                ctx.globalAlpha = 0.9;
                ctx.drawImage(marcaAgua, posX, posY, larguraMarca, alturaMarca);
                ctx.globalAlpha = 1;
              }
              y += img.height;
            }

            canvas.toBlob(blob => {
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = 'manga-com-marca.png';
              document.body.appendChild(a);
              a.click();
              a.remove();
              URL.revokeObjectURL(url);
            }, 'image/png');

            this.statusMsg = "‚úÖ Imagem final gerada com sucesso!";
            Swal.fire('Sucesso', 'Imagem final gerada com marca d\'√°gua!', 'success');
          }
          catch (error) {
            Swal.fire('Erro', error.message || error, 'error');
          }
          finally {
            this.loading = false;
          }
        }
      }
    }
  </script>
</body>
</html>
